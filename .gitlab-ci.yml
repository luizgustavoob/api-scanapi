stages:
  - build
  - test
  - scan-external
  - scan-internal
  - pages

build:
  stage: build
  tags:
    - shell
  script:
    - make build

test:
  stage: test
  tags:
    - shell
  before_script:
    - make env
  script:
    - make test
  after_script:
    - make env-stop
  artifacts:
    when: always
    paths:
      - coverage
    expire_in: 1 days
  coverage: '/total\:\s*\(statements\)\s*\d{1,}\.\d\%/'

scan-external:
  stage: scan-external
  tags:
    - shell
  script:
    - make scan-external
  artifacts:
    when: always
    paths:
      - coverage
    expire_in: 1 days

scan-internal:
  stage: scan-internal
  tags:
    - shell
  before_script:
    - make env
    - make image
    - make run-docker
  script:
    - make scan-internal
  after_script:
    - make remove-docker
    - make env-stop
  artifacts:
    when: always
    paths:
      - coverage
    expire_in: 1 days

pages:
  stage: pages
  tags:
    - shell
  dependencies:
    - test
    - scan-external
    - scan-internal
  script:
    - mkdir public
    - mv coverage/ public/
  artifacts:
    untracked: true
    when: always
    paths:
      - public
    expire_in: 360 days
